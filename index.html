<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>데블스 플랜 기사의 여행 게임</title>
  <!-- PWA & OG -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png" />
  <meta name="theme-color" content="#ffb703" />
  <meta property="og:title" content="데블스 플랜 기사의 여행 게임 – Knight Tour PWA" />
  <meta property="og:description" content="브라우저에서 즐기는 나이트 투어 퍼즐 – 오프라인에서도 플레이 가능!" />
  <meta property="og:image" content="open_graph.png" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* 1.5× 모바일 확대 스타일 (v6) */
  *{box-sizing:border-box}
  body{font-family:"Pretendard",Arial,sans-serif;background:#f7f7f7;margin:0;padding:1.5rem .8rem;text-align:center}
  h1{margin:0 0 .3rem;font-size:2.3rem;line-height:1.2}
  h1 small{display:block;font-size:1.04rem;margin-top:.18rem;color:#555}
  #controls{display:flex;flex-wrap:wrap;justify-content:center;gap:.6rem;margin-bottom:1.1rem}
  select,button{padding:.6rem 1rem;font-size:1.17rem;border:1px solid #bbb;border-radius:7px;cursor:pointer}
  button:disabled{cursor:not-allowed;opacity:.6}
  #board{display:grid;gap:0;column-gap:0;row-gap:0;justify-content:start;margin:0 auto;max-width:95vw}
  .cell{width:100px;height:100px;background:#fff;border:1px solid #999;display:flex;align-items:center;justify-content:center;font-size:1.45rem;user-select:none}
  .cell.valid{background:#2d6a4f;color:#fff}
  .cell.hint{background:#e63946;color:#fff}
  .cell.visited{background:#a0c4ff}
  #status{margin-top:1.1rem;font-size:1.17rem;font-weight:700}
  .guide-btn{display:inline-block;margin-top:.75rem;padding:.65rem 1.45rem;background:#ffb703;color:#fff!important;text-decoration:none;border-radius:9px;font-size:1.17rem;font-weight:600;transition:filter .15s}
  .guide-btn:hover{filter:brightness(.9)}
  </style>
</head>
<body>
  <h1>데블스 플랜 기사의 여행 게임<small>– 나이트 투어 퍼즐 –</small></h1>
  <div id="controls">
    <label style="font-size:1.17rem">체스판 크기 :
      <select id="sizeSelect">
        <option value="5">5 × 5</option>
        <option value="6">6 × 6</option>
        <option value="7">7 × 7</option>
        <option value="8">8 × 8</option>
      </select>
    </label>
    <button id="startBtn">게임 시작</button>
    <button id="undoBtn" disabled>뒤로 가기</button>
    <button id="hintBtn" disabled>힌트 보기</button>
    <button id="toggleBtn">이동 칸 표시 OFF</button>
  </div>
  <div id="board"></div>
  <div id="status"></div>
  <a href="https://blog.naver.com/kimsol1015/223862326616" target="_blank" rel="noopener noreferrer" class="guide-btn">공략 보러 가기</a>

<script>
/***************** 전역 & 상수 *****************/
const CELL=100;
const boardEl=document.getElementById('board'),sizeSelectEl=document.getElementById('sizeSelect'),startBtn=document.getElementById('startBtn'),undoBtn=document.getElementById('undoBtn'),hintBtn=document.getElementById('hintBtn'),toggleBtn=document.getElementById('toggleBtn'),statusEl=document.getElementById('status');
const DIRS=[{dx:1,dy:2},{dx:2,dy:1},{dx:2,dy:-1},{dx:1,dy:-2},{dx:-1,dy:-2},{dx:-2,dy:-1},{dx:-2,dy:1},{dx:-1,dy:2}];
let N,visited,stack,cur,showMoves=true,lockedPath=null;

/***************** 보드 초기화 *****************/
function initBoard(size){
  N=size;
  visited=Array.from({length:N},()=>Array(N).fill(false));
  stack=[{x:0,y:0}];
  cur={x:0,y:0};
  visited[0][0]=true;
  lockedPath=null;
  boardEl.style.gridTemplateColumns=`repeat(${N},135px)`;
  render(); highlight(); updateStatus();
  undoBtn.disabled=false; hintBtn.disabled=false;
}

/***************** 렌더링 & 하이라이트 *****************/
function render(){
  boardEl.innerHTML='';
  for(let y=0;y<N;y++){
    for(let x=0;x<N;x++){
      const div=document.createElement('div');
      div.className='cell'; div.dataset.x=x; div.dataset.y=y;
      if(visited[y][x]){
        div.classList.add('visited');
        const idx=stack.findIndex(p=>p.x===x&&p.y===y);
        div.textContent=idx>=0?idx+1:'';
      }
      boardEl.appendChild(div);
    }
  }
}
function valid(x,y){return x>=0&&y>=0&&x<N&&y<N&&!visited[y][x];}
function highlight(){
  document.querySelectorAll('.cell').forEach(c=>c.classList.remove('valid','hint'));
  if(!showMoves)return;
  DIRS.forEach(({dx,dy})=>{
    const nx=cur.x+dx, ny=cur.y+dy;
    if(valid(nx,ny)){
      const c=document.querySelector(`.cell[data-x="${nx}"][data-y="${ny}"]`);
      if(c)c.classList.add('valid');
    }
  });
}

/***************** 게임 로직 *****************/
function isKnightL(x,y){
  const dx=Math.abs(cur.x-x), dy=Math.abs(cur.y-y);
  return (dx===1&&dy===2)||(dx===2&&dy===1);
}
function move(x,y){
  cur={x,y}; visited[y][x]=true; stack.push({x,y});
  render(); highlight(); updateStatus();
}
function undo(){
  if(stack.length<=1)return;
  const last=stack.pop(); visited[last.y][last.x]=false;
  cur=stack[stack.length-1]; lockedPath=null;
  render(); highlight(); updateStatus();
}
function updateStatus(){
  const total=N*N, done=stack.length;
  statusEl.textContent=`이동 횟수: ${done} / ${total}`;
  if(done===total){alert('성공했습니다! 🎉');return;}
  if(!DIRS.some(({dx,dy})=>valid(cur.x+dx,cur.y+dy))){alert('실패했습니다. 다시 도전!'); lockedPath=null;}
}

/***************** 힌트 *****************/
function onwardCnt(x,y,v){return DIRS.filter(({dx,dy})=>{const nx=x+dx,ny=y+dy;return nx>=0&&ny>=0&&nx<N&&ny<N&&!v[ny][nx];}).length;}
function buildPath(){
  const v=visited.map(r=>r.slice()), p=stack.slice();
  function dfs(x,y,c){
    if(c===N*N)return true;
    const moves=DIRS.map(({dx,dy})=>({x:x+dx,y:y+dy}))
      .filter(({x,y})=>x>=0&&y>=0&&x<N&&y<N&&!v[y][x])
      .sort((a,b)=>onwardCnt(a.x,a.y,v)-onwardCnt(b.x,b.y,v));
    for(const m of moves){v[m.y][m.x]=true;p.push(m);if(dfs(m.x,m.y,c+1))return true;p.pop();v[m.y][m.x]=false;}
    return false;
  }
  return dfs(cur.x,cur.y,stack.length)?p:null;
}
function hint(){
  if(!lockedPath)lockedPath=buildPath();
  if(lockedPath){
    const n=lockedPath[stack.length];
    if(n){const c=document.querySelector(`.cell[data-x="${n.x}"][data-y="${n.y}"]`);if(c)c.classList.add('hint');}
    else alert('더 이상 힌트가 없습니다!');
  }else alert('성공 경로가 없습니다.');
}

/***************** 표시 토글 *****************/
function toggleShow(){showMoves=!showMoves;toggleBtn.textContent=showMoves?'이동 칸 표시 OFF':'이동 칸 표시 ON';highlight();}

/***************** 이벤트 바인딩 *****************/
boardEl.addEventListener('click',e=>{
  const cell=e.target.closest('.cell'); if(!cell) return;
  const x=+cell.dataset.x, y=+cell.dataset.y;
  if(!valid(x,y)||!isKnightL(x,y)) return; // 🔒 최종 차단
  move(x,y);
});
startBtn.addEventListener('click',()=>initBoard(+sizeSelectEl.value));
undoBtn.addEventListener('click',undo);
hintBtn.addEventListener('click',hint);
toggleBtn.addEventListener('click',toggleShow);

initBoard(5);
if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(console.error));}
</script>
</body>
</html>